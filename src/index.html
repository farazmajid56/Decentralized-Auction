<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decentralized Auction House</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.3.0/dist/web3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .title-bar {
            background-color: #333;
            color: #fff;
            padding: 10px;
            text-align: center;
        }
        .feed {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            padding: 20px;
        }
        .card {
            border: 1px solid #ccc;
            border-radius: 5px;
            width: 300px;
            margin-bottom: 20px;
            padding: 20px;
            text-align: center;
        }
        .card img {
            width: 100%;
            height: 200px; /* Changed for better layout */
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .timer, .bid-info, .buyout-info {
            font-size: 18px;
            text-align: center;
            margin-top: 10px;
        }
        .bid-button, .buyout-button {
            display: block;
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
        }
        .buyout-button {
            background-color: #28a745;
        }
        .buyout-button:hover, .bid-button:hover {
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="title-bar">
        <h1>Decentralized Auction House</h1>
        <p>By: Faraz Majid 20L-1162 & Aemon Fatima 20L-1057</p>
    </div>
    <div class="feed" id="auctionItems">
        <!-- Items will be loaded here dynamically -->
    </div>
    <script>
        var contract;
        var userAccount;

        window.addEventListener('load', async function() {
            if (window.ethereum) {
                window.web3 = new Web3(ethereum);
                try {
                    await ethereum.enable();
                    initApp();
                } catch (error) {
                    console.error("User denied account access...");
                }
            } else if (window.web3) {
                window.web3 = new Web3(web3.currentProvider);
                initApp();
            } else {
                console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');
            }
        });

        function initApp() {
            const abi = [
                            {
                              "inputs": [],
                              "stateMutability": "nonpayable",
                              "type": "constructor"
                            },
                            {
                              "anonymous": false,
                              "inputs": [
                                {
                                  "indexed": false,
                                  "internalType": "uint256",
                                  "name": "itemId",
                                  "type": "uint256"
                                },
                                {
                                  "indexed": false,
                                  "internalType": "string",
                                  "name": "name",
                                  "type": "string"
                                },
                                {
                                  "indexed": false,
                                  "internalType": "uint256",
                                  "name": "minBid",
                                  "type": "uint256"
                                },
                                {
                                  "indexed": false,
                                  "internalType": "uint256",
                                  "name": "buyoutPrice",
                                  "type": "uint256"
                                },
                                {
                                  "indexed": false,
                                  "internalType": "uint256",
                                  "name": "auctionEndTime",
                                  "type": "uint256"
                                }
                              ],
                              "name": "AuctionCreated",
                              "type": "event"
                            },
                            {
                              "anonymous": false,
                              "inputs": [
                                {
                                  "indexed": false,
                                  "internalType": "uint256",
                                  "name": "itemId",
                                  "type": "uint256"
                                },
                                {
                                  "indexed": false,
                                  "internalType": "address",
                                  "name": "winner",
                                  "type": "address"
                                },
                                {
                                  "indexed": false,
                                  "internalType": "uint256",
                                  "name": "amount",
                                  "type": "uint256"
                                }
                              ],
                              "name": "AuctionEnded",
                              "type": "event"
                            },
                            {
                              "anonymous": false,
                              "inputs": [
                                {
                                  "indexed": false,
                                  "internalType": "uint256",
                                  "name": "itemId",
                                  "type": "uint256"
                                },
                                {
                                  "indexed": false,
                                  "internalType": "address",
                                  "name": "bidder",
                                  "type": "address"
                                },
                                {
                                  "indexed": false,
                                  "internalType": "uint256",
                                  "name": "amount",
                                  "type": "uint256"
                                }
                              ],
                              "name": "HighestBidIncreased",
                              "type": "event"
                            },
                            {
                              "anonymous": false,
                              "inputs": [
                                {
                                  "indexed": false,
                                  "internalType": "uint256",
                                  "name": "itemId",
                                  "type": "uint256"
                                },
                                {
                                  "indexed": false,
                                  "internalType": "address",
                                  "name": "buyer",
                                  "type": "address"
                                },
                                {
                                  "indexed": false,
                                  "internalType": "uint256",
                                  "name": "amount",
                                  "type": "uint256"
                                }
                              ],
                              "name": "ItemBoughtOut",
                              "type": "event"
                            },
                            {
                              "inputs": [
                                {
                                  "internalType": "uint256",
                                  "name": "",
                                  "type": "uint256"
                                }
                              ],
                              "name": "items",
                              "outputs": [
                                {
                                  "internalType": "uint256",
                                  "name": "id",
                                  "type": "uint256"
                                },
                                {
                                  "internalType": "address payable",
                                  "name": "seller",
                                  "type": "address"
                                },
                                {
                                  "internalType": "string",
                                  "name": "name",
                                  "type": "string"
                                },
                                {
                                  "internalType": "string",
                                  "name": "imageUrl",
                                  "type": "string"
                                },
                                {
                                  "internalType": "uint256",
                                  "name": "minBid",
                                  "type": "uint256"
                                },
                                {
                                  "internalType": "uint256",
                                  "name": "buyoutPrice",
                                  "type": "uint256"
                                },
                                {
                                  "internalType": "uint256",
                                  "name": "auctionEndTime",
                                  "type": "uint256"
                                },
                                {
                                  "internalType": "address",
                                  "name": "highestBidder",
                                  "type": "address"
                                },
                                {
                                  "internalType": "uint256",
                                  "name": "highestBid",
                                  "type": "uint256"
                                },
                                {
                                  "internalType": "bool",
                                  "name": "ended",
                                  "type": "bool"
                                }
                              ],
                              "stateMutability": "view",
                              "type": "function",
                              "constant": true
                            },
                            {
                              "inputs": [
                                {
                                  "internalType": "address",
                                  "name": "",
                                  "type": "address"
                                }
                              ],
                              "name": "pendingReturns",
                              "outputs": [
                                {
                                  "internalType": "uint256",
                                  "name": "",
                                  "type": "uint256"
                                }
                              ],
                              "stateMutability": "view",
                              "type": "function",
                              "constant": true
                            },
                            {
                              "inputs": [
                                {
                                  "internalType": "string",
                                  "name": "name",
                                  "type": "string"
                                },
                                {
                                  "internalType": "string",
                                  "name": "imageUrl",
                                  "type": "string"
                                },
                                {
                                  "internalType": "uint256",
                                  "name": "minBid",
                                  "type": "uint256"
                                },
                                {
                                  "internalType": "uint256",
                                  "name": "buyoutPrice",
                                  "type": "uint256"
                                },
                                {
                                  "internalType": "uint256",
                                  "name": "biddingTime",
                                  "type": "uint256"
                                }
                              ],
                              "name": "addItem",
                              "outputs": [],
                              "stateMutability": "nonpayable",
                              "type": "function"
                            },
                            {
                              "inputs": [
                                {
                                  "internalType": "uint256",
                                  "name": "itemId",
                                  "type": "uint256"
                                }
                              ],
                              "name": "bid",
                              "outputs": [],
                              "stateMutability": "payable",
                              "type": "function",
                              "payable": true
                            },
                            {
                              "inputs": [],
                              "name": "withdraw",
                              "outputs": [
                                {
                                  "internalType": "bool",
                                  "name": "",
                                  "type": "bool"
                                }
                              ],
                              "stateMutability": "nonpayable",
                              "type": "function"
                            },
                            {
                              "inputs": [
                                {
                                  "internalType": "uint256",
                                  "name": "itemId",
                                  "type": "uint256"
                                }
                              ],
                              "name": "buyout",
                              "outputs": [],
                              "stateMutability": "payable",
                              "type": "function",
                              "payable": true
                            },
                            {
                              "inputs": [
                                {
                                  "internalType": "uint256",
                                  "name": "itemId",
                                  "type": "uint256"
                                }
                              ],
                              "name": "endAuction",
                              "outputs": [],
                              "stateMutability": "nonpayable",
                              "type": "function"
                            },
                            {
                              "inputs": [],
                              "name": "itemsCount",
                              "outputs": [
                                {
                                  "internalType": "uint256",
                                  "name": "",
                                  "type": "uint256"
                                }
                              ],
                              "stateMutability": "view",
                              "type": "function",
                              "constant": true
                            }
            ];
            const contractAddress = '0x3A1ACAF34c46b0AB2F53A902EBBc2B14fafB8eB0';
            contract = new web3.eth.Contract(abi, contractAddress);

            web3.eth.getAccounts(function(err, accounts) {
                if (err != null) {
                    console.error("An error occurred: " + err);
                } else if (accounts.length == 0) {
                    console.error("No account is logged in with MetaMask");
                } else {
                    userAccount = accounts[0];
                    loadItems();
                }
            });
        }

        function loadItems() {
            contract.methods.itemsCount().call().then(function(count) {
                for (let i = 0; i < count; i++) {
                    contract.methods.items(i).call().then(function(item) {
                        displayItem(item, i);
                    });
                }
            });
        }

        function displayItem(item, index) {
            const itemsContainer = document.getElementById('auctionItems');
            const etherValue = web3.utils.fromWei;
            const html = `
                <div class="card">
                    <img src="${item.imageUrl}" alt="${item.name}">
                    <h2>${item.name}</h2>
                    <p class="bid-info">Current Bid Price: ${etherValue(item.highestBid, 'ether')} TST</p>
                    <p class="buyout-info">Buyout Price: ${etherValue(item.buyoutPrice, 'ether')} TST</p>
                    <div class="timer" id="timer-${index}">Time Left: 00:00</div>
                    <button class="bid-button" onclick="placeBid(${item.id})">Place Bid</button>
                    <button class="buyout-button" onclick="buyout(${item.id})">Buy Now</button>
                </div>
            `;
            itemsContainer.innerHTML += html;
            updateTimer(index, item.auctionEndTime);
        }

        function placeBid(itemId) {
            var bidAmount = prompt("Enter your bid amount in ETH:");
            if (bidAmount != null) {
                contract.methods.bid(itemId).send({
                    from: userAccount,
                    value: web3.utils.toWei(bidAmount, 'ether')
                });
            }
        }

        function buyout(itemId) {
            contract.methods.items(itemId).call().then(function(item) {
                contract.methods.buyout(itemId).send({
                    from: userAccount,
                    value: item.buyoutPrice
                });
            });
        }

        function updateTimer(index, endTime) {
            const timer = document.getElementById(`timer-${index}`);
            const x = setInterval(function() {
                let now = new Date().getTime();
                let distance = endTime * 1000 - now;
                let hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                let minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                let seconds = Math.floor((distance % (1000 * 60)) / 1000);
                timer.innerHTML = `Time Left: ${hours}h ${minutes}m ${seconds}s`;

                if (distance < 0) {
                    clearInterval(x);
                    timer.innerHTML = "EXPIRED";
                }
            }, 1000);
        }
    </script>
</body>
</html>
